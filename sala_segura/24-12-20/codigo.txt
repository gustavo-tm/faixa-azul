library(tidyverse)
library(sf)
library(gganimate)
library(plotly)

velocidade <- read_csv("iFood_Velocidade_Media.csv", col_types = list(osm_id = "c")) |> 
  rename(id_osm = osm_id)
distrito <- st_read("distrito/SIRGAS_SHP_distrito.shp")
trechos <- st_read("trechos.gpkg") |> 
  select(id_osm, logradouro, tipo_via, limite_velocidade, comprimento, geometry = geom)
faixa_azul <- read_csv("faixa_azul.csv", col_types = list(id_osm = "c"))

velocidade |> 
  mutate(data = as_date(month_partition, format = "%Y-%m")) |> 
  drop_na() |> 
  distinct(id_osm, data) |> 
  mutate(dado = TRUE) |> 
  complete(id_osm, data, fill = list(dado = FALSE)) |> 
  write_csv("dado_disponivel.csv")

gg <- velocidade |> 
  mutate(data = as_date(month_partition, format = "%Y-%m")) |> 
  group_by(data) |> 
  summarize(rotas = sum(routes)) |> 
  ggplot(aes(x = data, y = rotas)) +
  geom_line() +
  geom_point() +
  scale_y_continuous(limits = c(100000, 180000), labels = scales::number) +
  theme_minimal()
ggsave("rotas-mes.pdf", gg, width = 8, height = 6)

df <- velocidade |> 
  mutate(data = as_date(month_partition, format = "%Y-%m")) |> 
  select(id_osm, data, rotas = routes, velocidade = average_velocity, distancia_percorrida = total_distance_km) |> 
  left_join(trechos) |> 
  left_join(faixa_azul) |> 
  mutate(faixa_azul = case_when(is.na(data_implementacao) ~ "nunca",
                                data_implementacao >= data ~ "ainda nao",
                                data_implementacao < data ~ "sim",
                                TRUE ~ "erro"),
         velocidade_relativa = velocidade - as.numeric(limite_velocidade))


gg <- df |> 
  filter(data == max(data)) |> 
  ggplot() +
  geom_sf(aes(geometry = geometry, lwd = rotas, colour = velocidade), alpha = .9) +
  theme_void() +
  scale_colour_gradient(low = "grey90", high = "darkblue", limits = c(0, 100))

ggsave("mapa_velocidade.pdf", gg, width = 20, height = 25)

gg <- df |> 
  st_drop_geometry() |> 
  group_by(id_osm) |> 
  summarize(rotas = sum(rotas)) |> 
  left_join(trechos) |> 
  ggplot() +
  geom_sf(aes(geometry = geometry, colour = rotas), lwd = 1, alpha = .9) +
  theme_void() +
  scale_colour_gradient(low = "grey5", high = "white", limits = c(0, 3000)) +
  theme(panel.background = element_rect(fill = "black"))

ggsave("rotas.pdf", gg, width = 20, height = 25)


gg <- df |> 
  st_drop_geometry() |> 
  group_by(id_osm) |> 
  summarize(velocidade_relativa = mean(velocidade_relativa, na.rm = T),
            rotas = sum(rotas)) |> 
  left_join(trechos) |> 
  filter(tipo_via %in% c("trunk", "primary", "secondary")) |> 
  mutate(vel = cut(velocidade_relativa, breaks = c(-Inf, -10, 0, 10, Inf))) |> 
  ggplot() +
  geom_sf(aes(geometry = geometry, lwd = rotas, colour = vel), alpha = .9) +
  theme_void() +
  scale_colour_manual(values = c("lightgrey", "grey", "darkgrey", "grey30", "grey5"), na.value = NA)

ggsave("test.pdf", gg, width = 20, height = 25)


datas <- df |> 
  arrange(data) |> 
  mutate(mes = data |> as.factor() |> as.numeric()) |> 
  distinct(data, mes)

gg <- df |> 
  st_drop_geometry() |> 
  left_join(datas) |> 
  left_join(datas |> rename(data_implementacao = data, mes_implementacao = mes)) |> 
  mutate(stagg = mes - mes_implementacao) |> 
  group_by(stagg) |> 
  summarize(rotas = sum(rotas),
            velocidade = weighted.mean(velocidade, comprimento),
            limite_velocidade = weighted.mean(as.numeric(limite_velocidade), comprimento),
            comprimento = sum(comprimento),
            faixa_azul = nth(faixa_azul, 1)) |> 
  ggplot(aes(x = stagg, y = velocidade)) +
  geom_line(aes(lwd = rotas, colour = comprimento)) +
  geom_point() +
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_minimal() +
  labs(x = "Meses até a implementação da faixa azul") +
  scale_linewidth_continuous(breaks = c(200, 500, 1000, 1500) * 10^3)

ggsave("velocidades.pdf", gg, width = 8, height = 6)


gg <- df |> 
  filter(data == max(data),
         tipo_via %in% c("trunk", "primary", "secondary")) |> 
  semi_join(df |> 
              group_by(logradouro, data) |> 
              summarize(rotas = sum(rotas),
                        velocidade = weighted.mean(velocidade, comprimento),
                        velocidade_relativa = weighted.mean(velocidade_relativa, comprimento),
                        limite_velocidade = weighted.mean(as.numeric(limite_velocidade), comprimento),
                        comprimento = sum(comprimento),
                        faixa_azul = nth(faixa_azul, 1)) |> 
              filter(velocidade_relativa > 0) |> 
              distinct(logradouro)) |> 
  ggplot() +
  geom_sf(aes(geometry = geometry), data = trechos |> 
            filter(tipo_via %in% c("trunk", "primary", "secondary")),
          colour = "grey80") +
  geom_sf(aes(geometry = geometry, colour = faixa_azul), lwd = 1) +
  theme_void() +
  labs(title = "Vias em que a velocidade média é superior à máxima")

ggsave("velocidade_relativa.pdf", gg, width = 20, height = 20)
